name: Network Tests

on:
  push:
    branches: [main]
    paths:
      - 'src/xai/network/**'
      - 'src/xai/p2p/**'
  pull_request:
    paths:
      - 'src/xai/network/**'
      - 'src/xai/p2p/**'
  schedule:
    - cron: '0 7 * * *'  # Daily at 7 AM UTC
  workflow_dispatch:

permissions:
  contents: read

jobs:
  p2p-unit-tests:
    name: P2P Unit Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: 'pip'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            libsecp256k1-dev \
            libgmp-dev \
            pkg-config

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip wheel setuptools
          pip install pytest pytest-cov pytest-mock pytest-asyncio
          pip install -e ".[dev,network]" || pip install -e ".[dev]" || pip install -e "."
        timeout-minutes: 15

      - name: Run P2P unit tests
        run: |
          if [ -d "tests/xai_tests/network" ]; then
            pytest tests/xai_tests/network/ -v \
              --cov=src/xai/network \
              --cov-report=xml
          else
            pytest tests/ -v -k "p2p or network or peer" \
              --cov=src --cov-report=xml || true
          fi

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.xml
          flags: network
        if: always()

  gossip-protocol-tests:
    name: Gossip Protocol Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: 'pip'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            libsecp256k1-dev \
            libgmp-dev \
            pkg-config

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip wheel setuptools
          pip install pytest pytest-cov pytest-mock pytest-asyncio
          pip install -e ".[dev,network]" || pip install -e ".[dev]" || pip install -e "."
        timeout-minutes: 15

      - name: Test gossip propagation
        run: pytest tests/ -v -k "gossip" || echo "No gossip tests found"

      - name: Test message broadcasting
        run: pytest tests/ -v -k "broadcast" || echo "No broadcast tests found"

      - name: Test peer discovery
        run: pytest tests/ -v -k "discovery or peer" || echo "No peer discovery tests found"

  multi-node-simulation:
    name: Multi-Node Simulation
    runs-on: ubuntu-latest
    timeout-minutes: 45
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: 'pip'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            libsecp256k1-dev \
            libgmp-dev \
            pkg-config

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip wheel setuptools
          pip install pytest pytest-cov pytest-mock pytest-asyncio
          pip install -e ".[dev,network,blockchain]" || pip install -e ".[dev]" || pip install -e "."
        timeout-minutes: 15

      - name: Run 3-node simulation
        run: |
          if [ -f "scripts/network_simulation.py" ]; then
            python scripts/network_simulation.py \
              --nodes 3 \
              --duration 60 \
              --output network-sim-3.json
          else
            echo "Network simulation script not found, skipping"
          fi
        continue-on-error: true

      - name: Run 5-node simulation
        run: |
          if [ -f "scripts/network_simulation.py" ]; then
            python scripts/network_simulation.py \
              --nodes 5 \
              --duration 120 \
              --output network-sim-5.json
          else
            echo "Network simulation script not found, skipping"
          fi
        continue-on-error: true

      - name: Upload simulation results
        uses: actions/upload-artifact@v4
        with:
          name: network-simulation-results
          path: network-sim-*.json
          retention-days: 30
          if-no-files-found: ignore

  network-partition-tests:
    name: Network Partition Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: 'pip'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            libsecp256k1-dev \
            libgmp-dev \
            pkg-config

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip wheel setuptools
          pip install pytest pytest-cov pytest-mock pytest-asyncio
          pip install -e ".[dev,network,blockchain]" || pip install -e ".[dev]" || pip install -e "."
        timeout-minutes: 15

      - name: Test network partition recovery
        run: pytest tests/ -v -k "partition" || echo "No partition tests found"
        continue-on-error: true

      - name: Test message ordering under delay
        run: pytest tests/ -v -k "delay or latency" || echo "No delay tests found"
        continue-on-error: true

  sentry-architecture-tests:
    name: Sentry Architecture Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: 'pip'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            libsecp256k1-dev \
            libgmp-dev \
            pkg-config

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip wheel setuptools
          pip install pytest pytest-cov pytest-mock pytest-asyncio
          pip install -e ".[dev,network]" || pip install -e ".[dev]" || pip install -e "."
        timeout-minutes: 15

      - name: Test sentry mode
        run: pytest tests/ -v -k "sentry" || echo "No sentry tests found"

      - name: Test private peers filtering
        run: pytest tests/ -v -k "private_peer or pex" || echo "No private peer tests found"

      - name: Test validator hiding
        run: pytest tests/ -v -k "validator and hide" || echo "No validator hiding tests found"
