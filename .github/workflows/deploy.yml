name: Deploy

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read
  security-events: write

env:
  PYTHON_VERSION: "3.12"
  CHAIN_ID: xai-mvp-testnet-1
  # xai-ansible repo for deployment configs (SINGLE SOURCE OF TRUTH)
  ANSIBLE_REPO: xai-blockchain/ansible

jobs:
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -e ".[dev,network,blockchain]"

      - name: Run pytest
        run: pytest tests/ -v --tb=short

      - name: Package source for deployment
        run: |
          # Create deployment package excluding unnecessary files
          mkdir -p dist
          tar --exclude='*.pyc' \
              --exclude='__pycache__' \
              --exclude='.git' \
              --exclude='.github' \
              --exclude='.venv' \
              --exclude='venv' \
              --exclude='.pytest_cache' \
              --exclude='*.egg-info' \
              --exclude='dist' \
              --exclude='build' \
              --exclude='node_modules' \
              --exclude='.mypy_cache' \
              -czvf dist/xai-source-${{ github.sha }}.tar.gz \
              src/ \
              requirements.txt \
              pyproject.toml \
              setup.py \
              README.md

      - name: Upload deployment package
        uses: actions/upload-artifact@v4
        with:
          name: xai-source-${{ github.sha }}
          path: dist/xai-source-${{ github.sha }}.tar.gz
          retention-days: 7

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Gitleaks - Check for secrets
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install Bandit
        run: |
          python -m pip install --upgrade pip
          pip install bandit[toml]

      - name: Run Bandit security scan
        run: |
          # Run Bandit with medium and high severity findings
          # Exit with error only on high severity issues
          bandit -r src/ -ll -f json -o bandit-results.json || true
          bandit -r src/ -ll -f screen

          # Fail on high severity issues
          HIGH_COUNT=$(cat bandit-results.json | python -c "import sys,json; d=json.load(sys.stdin); print(sum(1 for r in d.get('results',[]) if r.get('issue_severity')=='HIGH'))" 2>/dev/null || echo "0")
          if [ "$HIGH_COUNT" -gt "0" ]; then
            echo "::error::Found $HIGH_COUNT high severity security issues"
            exit 1
          fi

      - name: Upload Bandit results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: bandit-security-results
          path: bandit-results.json
          retention-days: 30

  deploy-testnet:
    name: Deploy to Testnet
    runs-on: ubuntu-latest
    needs: [build-and-test, security-scan]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: testnet
    concurrency:
      group: deploy-testnet
      cancel-in-progress: false

    steps:
      - name: Checkout XAI source code
        uses: actions/checkout@v4
        with:
          path: xai-source

      # =======================================================================
      # SINGLE SOURCE OF TRUTH: Checkout xai-ansible for all deployment configs
      # =======================================================================
      - name: Checkout xai-ansible (deployment configs)
        uses: actions/checkout@v4
        with:
          repository: ${{ env.ANSIBLE_REPO }}
          path: xai-ansible
          token: ${{ secrets.ANSIBLE_REPO_TOKEN }}

      - name: Download deployment package
        uses: actions/download-artifact@v4
        with:
          name: xai-source-${{ github.sha }}
          path: dist/

      - name: Setup Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Ansible
        run: |
          python -m pip install --upgrade pip
          pip install ansible

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          chmod 700 ~/.ssh

          # Add known hosts for testnet servers (via VPN IPs from secrets)
          ssh-keyscan -H ${{ secrets.XAI_TESTNET_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true
          ssh-keyscan -H ${{ secrets.SERVICES_TESTNET_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true

      # =======================================================================
      # Inject secrets into ansible inventory (hosts come from xai-ansible repo)
      # =======================================================================
      - name: Configure ansible with secrets
        run: |
          cd xai-ansible

          # Create group_vars with secrets (inventory structure comes from repo)
          mkdir -p group_vars
          cat > group_vars/secrets.yml << EOF
          # CI/CD injected secrets - DO NOT COMMIT
          ansible_user: ${{ secrets.DEPLOY_USER }}
          ansible_ssh_private_key_file: ~/.ssh/deploy_key
          deploy_version: ${{ github.sha }}
          EOF

          # Verify inventory exists in repo (ENFORCED - fail if missing)
          if [ ! -f inventory/testnet.yml ]; then
            echo "::error::inventory/testnet.yml missing from xai-ansible repo!"
            echo "::error::Deployment configs MUST come from xai-ansible repo (single source of truth)"
            exit 1
          fi

      # =======================================================================
      # Run deployment using playbooks FROM xai-ansible repo (NOT inline)
      # =======================================================================
      - name: Deploy XAI to testnet
        run: |
          cd xai-ansible

          # Copy deployment package to expected location
          mkdir -p ../dist
          cp ../dist/xai-source-${{ github.sha }}.tar.gz ../dist/

          # Run the update-code playbook from xai-ansible repo
          # This playbook is the SINGLE SOURCE OF TRUTH for deployment logic
          ansible-playbook \
            -i inventory/testnet.yml \
            playbooks/update-code.yml \
            -e "deploy_package=../dist/xai-source-${{ github.sha }}.tar.gz" \
            -e "deploy_version=${{ github.sha }}" \
            -e "chain_id=${{ env.CHAIN_ID }}" \
            -v
        env:
          ANSIBLE_HOST_KEY_CHECKING: "false"
          ANSIBLE_STDOUT_CALLBACK: yaml

      - name: Verify deployment
        run: |
          echo "Verifying deployment to testnet..."
          # Wait for services to stabilize
          sleep 30

          # Check primary sentry health
          curl -sf --max-time 30 \
            "https://testnet-rpc.xaiblockchain.com/stats" \
            | jq '{chain_height: .chain_height, peer_count: .peer_count, mining: .mining}' \
            || echo "::warning::Could not verify deployment health - check manually"

      - name: Deployment summary
        if: always()
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Chain ID**: ${{ env.CHAIN_ID }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Deployed at**: $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Ansible repo**: ${{ env.ANSIBLE_REPO }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Single Source of Truth" >> $GITHUB_STEP_SUMMARY
          echo "- **Code**: xai-blockchain/xai (this repo)" >> $GITHUB_STEP_SUMMARY
          echo "- **Deployment configs**: xai-blockchain/ansible" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Endpoints" >> $GITHUB_STEP_SUMMARY
          echo "- RPC: https://testnet-rpc.xaiblockchain.com" >> $GITHUB_STEP_SUMMARY
          echo "- Explorer: https://testnet-explorer.xaiblockchain.com" >> $GITHUB_STEP_SUMMARY
          echo "- Faucet: https://testnet-faucet.xaiblockchain.com" >> $GITHUB_STEP_SUMMARY
