name: Load Tests

on:
  schedule:
    - cron: '0 8 * * 0'  # Weekly on Sunday at 8 AM UTC
  workflow_dispatch:
    inputs:
      duration:
        description: 'Test duration in seconds'
        required: true
        default: '300'
      concurrent_users:
        description: 'Number of concurrent users'
        required: true
        default: '50'

permissions:
  contents: read

jobs:
  load-test:
    name: Run Load Tests
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev,network,blockchain]" || pip install -e ".[dev]"
          pip install locust aiohttp

      - name: Check for locust file
        id: locust-check
        run: |
          if [ -f "tests/load/locustfile.py" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Create locust file if needed
        if: steps.locust-check.outputs.exists == 'false'
        run: |
          mkdir -p tests/load
          cat > tests/load/locustfile.py << 'EOF'
          from locust import HttpUser, task, between
          import json

          class XAIUser(HttpUser):
              wait_time = between(1, 3)

              @task(10)
              def get_stats(self):
                  self.client.get("/stats")

              @task(5)
              def get_health(self):
                  self.client.get("/health")

              @task(3)
              def get_latest_block(self):
                  self.client.get("/block/latest")

              @task(2)
              def get_mempool(self):
                  self.client.get("/mempool")

              @task(1)
              def get_peers(self):
                  self.client.get("/peers")
          EOF

      - name: Start test node (if available)
        run: |
          if python -c "from xai.core import node" 2>/dev/null; then
            python -m xai.core.node --test-mode --rpc-port 8545 &
            sleep 10
            echo "TEST_NODE_STARTED=true" >> $GITHUB_ENV
          else
            echo "Test node not available, using testnet"
            echo "TEST_NODE_STARTED=false" >> $GITHUB_ENV
          fi
        continue-on-error: true

      - name: Run load tests with locust
        run: |
          if [ "$TEST_NODE_STARTED" = "true" ]; then
            HOST="http://localhost:8545"
          else
            HOST="https://testnet-rpc.xaiblockchain.com"
          fi

          locust -f tests/load/locustfile.py \
            --host "$HOST" \
            --headless \
            --users ${{ github.event.inputs.concurrent_users || '50' }} \
            --spawn-rate 5 \
            --run-time ${{ github.event.inputs.duration || '300' }}s \
            --html load-test-report.html \
            --csv load-test-results || echo "Locust completed"
        continue-on-error: true

      - name: Run TPS benchmark
        run: |
          if [ -f "scripts/benchmark_tps.py" ]; then
            python scripts/benchmark_tps.py \
              --tx-count 100 \
              --output load-test-tps.json || echo "TPS benchmark completed"
          else
            echo "TPS benchmark script not found"
          fi
        continue-on-error: true

      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: load-test-results
          path: |
            load-test-report.html
            load-test-results*.csv
            load-test-tps.json
          retention-days: 90
          if-no-files-found: ignore

  stress-test:
    name: Stress Test
    runs-on: ubuntu-latest
    timeout-minutes: 120
    if: github.event_name == 'workflow_dispatch'
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev,network,blockchain]" || pip install -e ".[dev]"
          pip install aiohttp

      - name: Run stress test
        run: |
          if [ -f "scripts/stress_test.py" ]; then
            python scripts/stress_test.py \
              --duration 600 \
              --ramp-up 60 \
              --max-tps 1000 \
              --output stress-test-results.json
          else
            echo "Creating basic stress test..."
            python << 'EOF'
          import asyncio
          import aiohttp
          import time
          import json

          async def stress_test():
              url = "https://testnet-rpc.xaiblockchain.com/stats"
              results = {"requests": 0, "errors": 0, "latencies": []}

              async with aiohttp.ClientSession() as session:
                  start = time.time()
                  while time.time() - start < 60:  # 1 minute stress test
                      try:
                          req_start = time.time()
                          async with session.get(url) as resp:
                              await resp.text()
                              results["latencies"].append(time.time() - req_start)
                              results["requests"] += 1
                      except Exception:
                          results["errors"] += 1
                      await asyncio.sleep(0.01)  # Rate limit

              results["duration"] = time.time() - start
              results["avg_latency"] = sum(results["latencies"]) / len(results["latencies"]) if results["latencies"] else 0
              results["rps"] = results["requests"] / results["duration"]

              with open("stress-test-results.json", "w") as f:
                  json.dump(results, f, indent=2)

              print(f"Completed: {results['requests']} requests, {results['errors']} errors, {results['rps']:.2f} RPS")

          asyncio.run(stress_test())
          EOF
          fi
        continue-on-error: true

      - name: Upload stress test results
        uses: actions/upload-artifact@v4
        with:
          name: stress-test-results
          path: stress-test-results.json
          retention-days: 90
          if-no-files-found: ignore
