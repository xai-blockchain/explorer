name: Security Scanning

# This workflow performs security scanning of Docker images, codebase,
# and Python dependencies using Trivy and pip-audit

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'Dockerfile*'
      - 'docker/**'
      - 'k8s/**'
      - 'src/**'
      - 'flask-app/**'
      - 'requirements*.txt'
      - 'pyproject.toml'
      - 'constraints.txt'
      - '.github/workflows/security-scan.yml'
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'Dockerfile*'
      - 'docker/**'
      - 'k8s/**'
      - 'src/**'
      - 'flask-app/**'
      - 'requirements*.txt'
      - 'pyproject.toml'
      - 'constraints.txt'
  schedule:
    # Run security scan daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  pull-requests: write

jobs:
  scan-dockerfiles:
    name: Scan Docker Images
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        dockerfile:
          - path: 'k8s/Dockerfile'
            image: 'xai-node-k8s'
            context: '.'
          - path: 'docker/node/Dockerfile'
            image: 'xai-node'
            context: '.'
          - path: 'docker/faucet/Dockerfile'
            image: 'xai-faucet'
            context: 'docker/faucet'
          - path: 'docker/explorer/Dockerfile'
            image: 'xai-explorer'
            context: '.'
          - path: 'flask-app/Dockerfile'
            image: 'xai-flask-app'
            context: 'flask-app'
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Check if Dockerfile exists
        id: check-dockerfile
        run: |
          if [ -f "${{ matrix.dockerfile.path }}" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Set up Docker Buildx
        if: steps.check-dockerfile.outputs.exists == 'true'
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        if: steps.check-dockerfile.outputs.exists == 'true'
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.dockerfile.context }}
          file: ${{ matrix.dockerfile.path }}
          push: false
          load: true
          tags: ${{ matrix.dockerfile.image }}:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Run Trivy vulnerability scanner
        if: steps.check-dockerfile.outputs.exists == 'true'
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ matrix.dockerfile.image }}:test
          format: 'sarif'
          output: 'trivy-results-${{ matrix.dockerfile.image }}.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'
          ignore-unfixed: true
          trivyignores: '.trivyignore'

      - name: Upload Trivy results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always() && steps.check-dockerfile.outputs.exists == 'true'
        with:
          sarif_file: 'trivy-results-${{ matrix.dockerfile.image }}.sarif'
          category: 'trivy-${{ matrix.dockerfile.image }}'

      - name: Run Trivy vulnerability scanner (table output)
        if: always() && steps.check-dockerfile.outputs.exists == 'true'
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ matrix.dockerfile.image }}:test
          format: 'table'
          severity: 'CRITICAL,HIGH'
          ignore-unfixed: true
          trivyignores: '.trivyignore'

  scan-python-dependencies:
    name: Scan Python Dependencies
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install pip-audit
        run: pip install pip-audit

      - name: Find and audit requirements files
        run: |
          echo "## Python Dependency Audit" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Find all requirements files
          req_files=$(find . -name 'requirements*.txt' -not -path '*/node_modules/*' -not -path '*/.venv/*' 2>/dev/null || true)

          if [ -z "$req_files" ]; then
            echo "No requirements.txt files found" >> $GITHUB_STEP_SUMMARY
            exit 0
          fi

          overall_exit=0
          for req_file in $req_files; do
            echo "### Scanning: $req_file" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # Run pip-audit and capture output
            if pip-audit -r "$req_file" --progress-spinner=off 2>&1 | tee audit_output.txt; then
              echo "No vulnerabilities found in $req_file" >> $GITHUB_STEP_SUMMARY
            else
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
              cat audit_output.txt >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
              overall_exit=1
            fi
            echo "" >> $GITHUB_STEP_SUMMARY
          done

          # Also audit pyproject.toml if it exists
          if [ -f "pyproject.toml" ]; then
            echo "### Scanning: pyproject.toml" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # Install the package in a temp venv and audit
            python -m venv /tmp/audit_venv
            source /tmp/audit_venv/bin/activate
            pip install pip-audit

            # Try to install dependencies from pyproject.toml
            if pip install . 2>/dev/null; then
              if pip-audit --progress-spinner=off 2>&1 | tee audit_output.txt; then
                echo "No vulnerabilities found in pyproject.toml dependencies" >> $GITHUB_STEP_SUMMARY
              else
                echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
                cat audit_output.txt >> $GITHUB_STEP_SUMMARY
                echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
                overall_exit=1
              fi
            else
              echo "Could not install from pyproject.toml (may have non-Python dependencies)" >> $GITHUB_STEP_SUMMARY
            fi
            deactivate
          fi

          exit $overall_exit
        continue-on-error: true

      - name: Generate pip-audit SARIF output
        run: |
          # Generate SARIF for the main requirements file if it exists
          if [ -f "requirements.txt" ]; then
            pip-audit -r requirements.txt --format=json --progress-spinner=off > pip-audit-results.json 2>/dev/null || true
          elif [ -f "src/xai/requirements.txt" ]; then
            pip-audit -r src/xai/requirements.txt --format=json --progress-spinner=off > pip-audit-results.json 2>/dev/null || true
          fi
        continue-on-error: true

  scan-filesystem:
    name: Scan Filesystem
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Run Trivy filesystem scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-fs-results.sarif'
          severity: 'CRITICAL,HIGH'
          ignore-unfixed: true
          scanners: 'vuln,secret'

      - name: Upload Trivy filesystem results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-fs-results.sarif'
          category: 'trivy-filesystem'

      - name: Run Trivy filesystem scanner (table output)
        uses: aquasecurity/trivy-action@master
        if: always()
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'table'
          severity: 'CRITICAL,HIGH'
          ignore-unfixed: true
          scanners: 'vuln,secret'

  scan-config:
    name: Scan Configuration Files
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Run Trivy config scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-config-results.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'

      - name: Upload Trivy config results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-config-results.sarif'
          category: 'trivy-config'

      - name: Run Trivy config scanner (table output)
        uses: aquasecurity/trivy-action@master
        if: always()
        with:
          scan-type: 'config'
          scan-ref: '.'
          format: 'table'
          severity: 'CRITICAL,HIGH,MEDIUM'

  scan-secrets:
    name: Scan for Secrets
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Run Trivy secret scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-secrets-results.sarif'
          scanners: 'secret'

      - name: Upload Trivy secrets results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-secrets-results.sarif'
          category: 'trivy-secrets'

      - name: Run Trivy secret scanner (table output)
        uses: aquasecurity/trivy-action@master
        if: always()
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'table'
          scanners: 'secret'

  summary:
    name: Security Scan Summary
    runs-on: ubuntu-latest
    needs: [scan-dockerfiles, scan-python-dependencies, scan-filesystem, scan-config, scan-secrets]
    if: always()
    steps:
      - name: Summary
        run: |
          echo "## Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Security scanning completed. Check the Security tab for detailed results." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Scanned Components" >> $GITHUB_STEP_SUMMARY
          echo "- **Docker images**: xai-node-k8s, xai-node, xai-faucet, xai-explorer, xai-flask-app" >> $GITHUB_STEP_SUMMARY
          echo "- **Python dependencies**: pip-audit for requirements.txt and pyproject.toml" >> $GITHUB_STEP_SUMMARY
          echo "- **Filesystem**: Source code and dependencies for known vulnerabilities" >> $GITHUB_STEP_SUMMARY
          echo "- **Configuration**: Dockerfiles, YAML, and other config files for misconfigurations" >> $GITHUB_STEP_SUMMARY
          echo "- **Secrets**: Scanning for accidentally committed secrets and credentials" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Severity Levels" >> $GITHUB_STEP_SUMMARY
          echo "- Docker images: CRITICAL, HIGH, MEDIUM" >> $GITHUB_STEP_SUMMARY
          echo "- Filesystem: CRITICAL, HIGH" >> $GITHUB_STEP_SUMMARY
          echo "- Configuration: CRITICAL, HIGH, MEDIUM" >> $GITHUB_STEP_SUMMARY
